import React, { useState, useEffect } from 'react';
import { useQuery } from '@apollo/client';
import { useLocation } from 'react-router-dom';
import { PageContainer, PageHeader } from '../components/layout/PageContainer';
import { Card } from '../components/ui/Card';
import { Button } from '../components/ui/Button';
import { DirectMessageInbox } from '../components/messaging/DirectMessageInbox';
import { DirectMessageThread } from '../components/messaging/DirectMessageThread';
import { UserSearchModal } from '../components/messaging/UserSearchModal';
import { useCurrentUser } from '../hooks/useCurrentUser';
import queries from '../queries';
import { MessageSquare, Plus } from 'lucide-react';

export const Messaging = () => {
  const location = useLocation();
  const [activeConversation, setActiveConversation] = useState(null);
  const [conversationsKey, setConversationsKey] = useState(0);
  const [isUserSearchOpen, setIsUserSearchOpen] = useState(false);

  const { user } = useCurrentUser();

  // Fetch conversations to find and auto-select from navigation state
  const { data: conversationsData } = useQuery(queries.CONVERSATIONS, {
    skip: !user?._id,
    fetchPolicy: 'network-only',
  });

  // Auto-select conversation when navigating from profile page
  useEffect(() => {
    const conversationId = location.state?.conversationId;
    if (conversationId && conversationsData?.conversations?.items) {
      const conversation = conversationsData.conversations.items.find(
        conv => conv._id === conversationId
      );
      if (conversation) {
        setActiveConversation(conversation);
      }
    }
  }, [location.state, conversationsData]);

  const handleSelectConversation = (conversation) => {
    setActiveConversation(conversation);
  };

  const handleBackToInbox = () => {
    setActiveConversation(null);
  };

  const handleConversationsUpdate = () => {
    // Trigger a re-render of conversations to update unread counts
    setConversationsKey(prev => prev + 1);
  };

  const handleUserSelected = (conversation) => {
    // When user is selected from search, set as active conversation
    setActiveConversation(conversation);

    // Trigger refresh to show new conversation in list
    setConversationsKey(prev => prev + 1);
  };

  return (
    <PageContainer>
      <PageHeader
        title="Messages"
        subtitle="Communicate with your colleagues"
        action={
          <Button onClick={() => setIsUserSearchOpen(true)} className="gap-2">
            <Plus className="w-4 h-4" />
            New Message
          </Button>
        }
      />

      <Card className="overflow-hidden h-[calc(100vh-200px)]">
        <div className="grid grid-cols-1 md:grid-cols-12 h-full">
          {/* Direct Message Inbox - Hidden on mobile when conversation is active */}
          <div className={`md:col-span-4 ${activeConversation ? 'hidden md:block' : 'block'}`}>
            <DirectMessageInbox
              key={conversationsKey}
              activeConversationId={activeConversation?._id}
              onSelectConversation={handleSelectConversation}
              onConversationsUpdate={handleConversationsUpdate}
            />
          </div>

          {/* Direct Message Thread - Full width on mobile when active */}
          <div className={`md:col-span-8 ${activeConversation ? 'block' : 'hidden md:block'}`}>
            {activeConversation ? (
              <DirectMessageThread
                conversation={activeConversation}
                onMessageSent={handleConversationsUpdate}
                onBack={handleBackToInbox}
              />
            ) : (
              <div className="flex items-center justify-center h-full bg-gray-50 p-8">
                <div className="text-center max-w-sm">
                  <div className="w-20 h-20 mx-auto mb-4 rounded-full bg-gray-100 flex items-center justify-center">
                    <MessageSquare className="w-10 h-10 text-gray-400" />
                  </div>
                  <p className="text-gray-900 font-semibold text-lg mb-2">No conversation selected</p>
                  <p className="text-sm text-gray-500">
                    Select a conversation from the sidebar to start messaging
                  </p>
                </div>
              </div>
            )}
          </div>
        </div>
      </Card>

      {/* User Search Modal for New Messages */}
      <UserSearchModal
        open={isUserSearchOpen}
        onOpenChange={setIsUserSearchOpen}
        onUserSelected={handleUserSelected}
      />
    </PageContainer>
  );
};
